<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Herramientas de Visualización - Dashboard de Ventas</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
        h1 {
          color: #12306c;
        }
    body { font-family: system-ui, Arial; margin: 16px; }
    .topbar {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
      background:#f3f3f3;
      border-radius:12px;
      padding:12px 18px;
    }
      h2 {
        text-align: center;
        margin-top: 20px;
        margin-bottom: 5px;
        color: #333;
        font-size: 1.6rem;
        font-weight: 600;
      }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { border:1px solid #e5e5e5; border-radius:12px; padding:12px; }
    #tooltip { position: fixed; pointer-events:none; background:#111; color:#fff; padding:8px 10px;
               border-radius:8px; font-size:12px; opacity:0; transform: translate(8px, 8px); }
    button {
      padding:18px 32px;
      border-radius:10px;
      border:1px solid #2d3590;
      cursor:pointer;
      background:#2d3590;
      color:#fff;
      font-weight:600;
      font-size:1.2rem;
      transition:background 0.2s;
    }
    button:hover {
      background:#2d3590;
    }
    #status { color:#333; }
  </style>
</head>

<body>
  <h2 style="width:60%; display:flex; justify-content:left; margin-top:24px; margin-bottom:10px; padding-left:40px;">Herramientas de Visualización</h2>
  <div class="topbar">
    <h1 style="flex:1;">Desempeño de Ventas (Ene - Feb)</h1>
    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
      <button id="btnActualizar">Actualizar</button>
      <span id="status" style="margin-top:2px;"></span>
    </div>
  </div>

  <!-- Producto Top centrado -->
  <div style="width:100%; display:flex; justify-content:center; margin-top:24px; margin-bottom:10px;">
    <div class="card" style="min-width:220px; text-align:center; background:#f8f8ff; box-shadow:0 2px 8px #eee;">
      <div style="font-size:20px; color:#555;">Producto Top</div>
      <div id="productoTop" style="font-size:32px; font-weight:bold; color:#3366cc;">-</div>
      <div id="productoTopVentas" style="font-size:16px; color:#888;"> </div>
    </div>
  </div>

  <!-- Resumen de métricas -->
  <div id="metricasResumen" style="width:100%; display:flex; gap:24px; margin:24px 0; flex-wrap:wrap; justify-content:center; align-items:center;">
    <div class="card" style="min-width:180px; text-align:center;">
      <div style="font-size:18px; color:#555;">Ventas totales</div>
      <div id="ventasTotales" style="font-size:32px; font-weight:bold;">-</div>
    </div>
    <div class="card" style="min-width:180px; text-align:center;">
      <div style="font-size:18px; color:#555;">Transacciones</div>
      <div id="numTransacciones" style="font-size:32px; font-weight:bold;">-</div>
    </div>
    <div class="card" style="min-width:180px; text-align:center;">
      <div style="font-size:18px; color:#555;">Promedio por venta</div>
      <div id="promedioVenta" style="font-size:32px; font-weight:bold;">-</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
        <h2>Ventas Mensuales por Producto</h2>
      <div id="googleChart" style="width:100%; height:420px;"></div>
    </div>

    <div class="card">
        <h2>Ventas por Producto (Ventas/Ingresos/Precio)</h2>
      <div id="d3Container" style="width:100%; height:420px;"></div>
    </div>

    <div class="card">
        <h2>Participación del Mercado</h2>
        <div id="donaMercado" style="width:100%; height:420px; display:flex; justify-content:center; align-items:center;"></div>
    </div>

    <div class="card">
      <h2>Evolución de Ventas (Área)</h2>
      <div id="areaVentas" style="width:100%; height:420px; display:flex; justify-content:center; align-items:center;"></div>
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
        function drawAreaVentas(data) {
          // Agrupa ventas totales por mes
          const meses = Array.from(new Set(data.map(d => d.mes)));
          const resumen = meses.map(mes => {
            const ventas = data.filter(d => d.mes === mes).reduce((sum, d) => sum + d.ventas, 0);
            return [mes, ventas];
          });
          const tableArr = [['Mes', 'Ventas'], ...resumen];
          const dataTable = google.visualization.arrayToDataTable(tableArr);
          const options = {
            legend: { position: 'none' },
            height: 420,
            chartArea: { left: 60, top: 50, width: '75%', height: '70%' },
            vAxis: { title: 'Ventas', minValue: 0 },
            hAxis: { title: 'Mes' },
            colors: ['#0099c6'],
            areaOpacity: 0.3,
            lineWidth: 3,
          };
          const chart = new google.visualization.AreaChart(document.getElementById('areaVentas'));
          chart.draw(dataTable, options);
        }
    let currentData = [];
    let googleChartInstance = null;
    let googleDataTable = null;
    let googleOptions = null;

    // GOOGLE CHARTS
    google.charts.load('current', { packages: ['corechart'] });

    function buildGoogleTable(data){
      const meses = Array.from(new Set(data.map(d => d.mes)));
      const productos = Array.from(new Set(data.map(d => d.producto)));

      // Header: Mes | prod1 | prod2 | ...
      const table = [['Mes', ...productos]];
      for (const mes of meses){
        const row = [mes];
        for (const p of productos){
          const item = data.find(d => d.mes === mes && d.producto === p);
          row.push(item ? item.ventas : 0);
        }
        table.push(row);
      }
      return table;
    }

    function drawGoogleChart(data){
      const tableArr = buildGoogleTable(data);
      googleDataTable = google.visualization.arrayToDataTable(tableArr);

      googleOptions = {
        legend: { position: 'top' },
        height: 420,
        chartArea: { left: 50, top: 50, width: '80%', height: '70%' },
        vAxis: { title: 'Ventas' },
        hAxis: { title: 'Mes' }
      };

      googleChartInstance = new google.visualization.ColumnChart(document.getElementById('googleChart'));
      googleChartInstance.draw(googleDataTable, googleOptions);
    }

    function redrawGoogleOnResize(){
      if (googleChartInstance && googleDataTable && googleOptions){
        googleChartInstance.draw(googleDataTable, googleOptions);
      }
    }

    // D3 (Burbujas)
    function drawD3(data){
      const container = document.getElementById("d3Container");
      container.innerHTML = "";

      const rect = container.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;

      const margin = { top: 30, right: 20, bottom: 50, left: 60 };
      const w = width - margin.left - margin.right;
      const h = height - margin.top - margin.bottom;

      const svg = d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const productos = Array.from(new Set(data.map(d => d.producto)));
      const meses = Array.from(new Set(data.map(d => d.mes)));

      const x = d3.scalePoint().domain(productos).range([0, w]).padding(0.5);
      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.ingresos) * 1.1])
        .range([h, 0]);

      const r = d3.scaleSqrt()
        .domain([0, d3.max(data, d => d.ventas)])
        .range([6, 30]);

      const color = d3.scaleOrdinal().domain(meses).range(d3.schemeTableau10);

      g.append("g").attr("transform", `translate(0,${h})`).call(d3.axisBottom(x));
      g.append("g").call(d3.axisLeft(y));

      g.append("text")
        .attr("x", w/2).attr("y", h + 40)
        .attr("text-anchor","middle").text("Producto");

      g.append("text")
        .attr("transform","rotate(-90)")
        .attr("x", -h/2).attr("y", -45)
        .attr("text-anchor","middle").text("Ingresos");

      const tooltip = d3.select("#tooltip");

      const circles = g.selectAll("circle")
        .data(data, d => `${d.producto}-${d.mes}`);

      circles.join(
        enter => enter.append("circle")
          .attr("cx", d => x(d.producto))
          .attr("cy", y(0))
          .attr("r", 0)
          .attr("fill", d => color(d.mes))
          .attr("opacity", 0.85)
          .on("mousemove", (event, d) => {
            tooltip.style("opacity", 1)
              .style("left", event.clientX + "px")
              .style("top", event.clientY + "px")
              .html(`
                <b>${d.producto}</b> (${d.mes})<br/>
                Ventas: ${d.ventas}<br/>
                Ingresos: $${d.ingresos}<br/>
                Precio: $${d.precio}
              `);
          })
          .on("mouseleave", () => tooltip.style("opacity", 0))
          .on("click", (_e, d) => alert(`Detalle: ${d.producto} - ${d.mes}`))
          .call(enter => enter.transition().duration(700)
            .attr("cy", d => y(d.ingresos))
            .attr("r", d => r(d.ventas))
          ),
        update => update.call(update => update.transition().duration(700)
          .attr("cx", d => x(d.producto))
          .attr("cy", d => y(d.ingresos))
          .attr("r", d => r(d.ventas))
        ),
        exit => exit.call(exit => exit.transition().duration(400).attr("r", 0).remove())
      );
    }


    function drawDonaMercado(data){
      // Agrupa ventas totales por producto
      const productos = Array.from(new Set(data.map(d => d.producto)));
      const ventasPorProducto = productos.map(p => {
        const total = data.filter(d => d.producto === p).reduce((sum, d) => sum + d.ventas, 0);
        return [p, total];
      });
      const totalVentas = ventasPorProducto.reduce((sum, v) => sum + v[1], 0);
      const tableArr = [['Producto', 'Ventas'], ...ventasPorProducto];
      const dataTable = google.visualization.arrayToDataTable(tableArr);
      const options = {
        pieHole: 0.5,
        legend: { position: 'right' },
        chartArea: { left: 20, top: 20, width: '90%', height: '80%' },
        height: 420,
        colors: ['#3366cc', '#dc3912', '#ff9900', '#109618', '#990099', '#0099c6', '#dd4477', '#66aa00'],
        tooltip: {
          trigger: 'focus',
          text: 'value',
        },
        pieSliceText: 'percentage',
      };
      const chart = new google.visualization.PieChart(document.getElementById('donaMercado'));
      google.visualization.events.addListener(chart, 'onmouseover', function(e) {
        const row = e.row;
        if (row != null) {
          const producto = dataTable.getValue(row, 0);
          const ventas = dataTable.getValue(row, 1);
          document.getElementById('tooltip').style.opacity = 1;
          document.getElementById('tooltip').innerHTML = `<b>${producto}</b><br>Ventas: ${ventas}`;
        }
      });
      google.visualization.events.addListener(chart, 'onmouseout', function() {
        document.getElementById('tooltip').style.opacity = 0;
      });
      chart.draw(dataTable, options);
    }
    function actualizarKPIs(data){
      // Ventas totales
      const ventasTotales = data.reduce((sum, d) => sum + d.ingresos, 0);
      // Transacciones (ventas)
      const numTransacciones = data.reduce((sum, d) => sum + d.ventas, 0);
      // Promedio por venta
      const promedioVenta = numTransacciones > 0 ? (ventasTotales / numTransacciones) : 0;
      document.getElementById('ventasTotales').textContent = `$${ventasTotales.toLocaleString()}`;
      document.getElementById('numTransacciones').textContent = numTransacciones.toLocaleString();
      document.getElementById('promedioVenta').textContent = `$${promedioVenta.toFixed(2)}`;

      // Producto Top
      const ventasPorProducto = {};
      data.forEach(d => {
        ventasPorProducto[d.producto] = (ventasPorProducto[d.producto] || 0) + d.ventas;
      });
      let topProducto = '-';
      let topVentas = 0;
      for (const [producto, ventas] of Object.entries(ventasPorProducto)) {
        if (ventas > topVentas) {
          topProducto = producto;
          topVentas = ventas;
        }
      }
      document.getElementById('productoTop').textContent = topProducto;
      document.getElementById('productoTopVentas').textContent = topVentas > 0 ? `Ventas: ${topVentas.toLocaleString()}` : '';
    }

    async function loadInitial(){
      document.getElementById("status").textContent = "Cargando...";
      const res = await fetch("/api/ventas");
      currentData = await res.json();

      google.charts.setOnLoadCallback(() => {
        drawGoogleChart(currentData);
        drawDonaMercado(currentData);
        drawAreaVentas(currentData);
        window.addEventListener("resize", () => {
          redrawGoogleOnResize();
          drawDonaMercado(currentData);
          drawAreaVentas(currentData);
        });
      });
      drawD3(currentData);
      actualizarKPIs(currentData);
      document.getElementById("status").textContent = "Cargado ✓";
    }

    async function actualizar(){
      document.getElementById("status").textContent = "Actualizando...";
      const res = await fetch("/api/actualizar");
      currentData = await res.json();

      // Redibuja todas las visualizaciones y KPIs sin recargar la página
      drawGoogleChart(currentData);
      drawDonaMercado(currentData);
      drawAreaVentas(currentData);
      drawD3(currentData);
      actualizarKPIs(currentData);
      document.getElementById("status").textContent = "Actualizado ✓";
    }

    document.getElementById("btnActualizar").addEventListener("click", actualizar);
    loadInitial();
  </script>
</body>
</html>
